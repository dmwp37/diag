/*==================================================================================================

    Module Name:  dg_dbg.c

    General Description: Implements the dg_dbg library

====================================================================================================

====================================================================================================
                                           INCLUDE FILES
==================================================================================================*/
#include <stdio.h>
#include <stdlib.h>
#include <stdarg.h>
#include "dg_dbg.h"

/** @addtogroup libdg_dbg
@{
*/
/*==================================================================================================
                                          LOCAL CONSTANTS
==================================================================================================*/

/*==================================================================================================
                                           LOCAL MACROS
==================================================================================================*/

/*==================================================================================================
                            LOCAL TYPEDEFS (STRUCTURES, UNIONS, ENUMS)
==================================================================================================*/

/*==================================================================================================
                                     LOCAL FUNCTION PROTOTYPES
==================================================================================================*/

/*==================================================================================================
                                         GLOBAL VARIABLES
==================================================================================================*/

/*==================================================================================================
                                          LOCAL VARIABLES
==================================================================================================*/
/*default dbg level is just print error */
static int dg_dbg_level = DG_DBG_LVL_ERROR;

/** last error string */
static char* dg_dbg_last_err_string = NULL;

/*==================================================================================================
                                         GLOBAL FUNCTIONS
==================================================================================================*/

/*=============================================================================================*//**
@brief Set debug level

@param[in] debug_level
*//*==============================================================================================*/
void DG_DBG_set_dbg_level(int debug_level)
{
    if (debug_level < DG_DBG_LVL_VERBOSE)
    {
        dg_dbg_level = DG_DBG_LVL_VERBOSE;
    }
    else if (debug_level > DG_DBG_LVL_DISABLE)
    {
        dg_dbg_level = DG_DBG_LVL_DISABLE;
    }
    else
    {
        dg_dbg_level = debug_level;
    }
}

/*=============================================================================================*//**
@brief Log out the debug message according to the debug level

@param[in]   debug_level
@param[in]   format, .... the formated string
*//*==============================================================================================*/
void DG_DBG_print(int debug_level, const char* format, ...)
{
    va_list args;

    va_start(args, format);
    if (debug_level >= dg_dbg_level)
    {
        printf("DIAG: ");
        vprintf(format, args);
        printf("\n");
        fflush(stdout);
    }
    va_end(args);
}

/*=============================================================================================*//**
@brief set the error string

@param[in]   format, .... the formated string
*//*==============================================================================================*/
void DG_DBG_set_err_string(const char* format, ...)
{
    va_list args;

    va_start(args, format);

    if (dg_dbg_last_err_string != NULL)
    {
        free(dg_dbg_last_err_string);
        dg_dbg_last_err_string = NULL;
    }
    vasprintf(&dg_dbg_last_err_string, format, args);
    DG_DBG_ERROR("%s", dg_dbg_last_err_string);

    va_end(args);
}

/*=============================================================================================*//**
@brief get that last error string

@return the error string, or NULL

@note
- caller must free the error string
*//*==============================================================================================*/
char* DG_DBG_get_err_string()
{
    char* err_str = dg_dbg_last_err_string;

    dg_dbg_last_err_string = NULL;

    return err_str;
}

/*==================================================================================================
                                          LOCAL FUNCTIONS
==================================================================================================*/


/** @} */

